#!/bin/sh

# Original version by Rob Landley of http://landley.net

[ $# -lt 2 ] && { echo "usage: $0 <dest> targets ..."; exit 1; }

dest=$1
shift

[ ! -d "$dest" ] && { echo "error: dir '$dest' does not exists"; exit 1; }
shift

mkchroot() {
  for i in "$@"
  do
    echo $i | grep -qP '^\.?/' || i=$(which $i)

    # Skip if target already exist
    [ -e "$dest/$i" ] && continue

    echo "f: $i -> $dest/$i"

    if [ -e "$i" ]
    then
      # Create destination path
      d=`echo "$i" | grep -o '.*/'` &&
      mkdir -p "$dest/$d" &&
      # Copy file
      cat "$i" > "$dest/$i" &&
      chmod +x "$dest/$i"
    else
      echo "Not found: $i"
    fi

    # Recursively copy shared libraries'
    mkchroot "$dest" $(ldd "$i" | egrep -o '/.* ')
  done
}

mkchroot "$@"
