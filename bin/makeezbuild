#!/bin/bash
if [[ ! -e ezpm.php ]]
then
    if [[ -z "${1}" ]]
    then
        echo "Not a eZ site... Add a sitename when running the script"
        exit 1
    fi

    source ~/.profile 

    sites $1

    if [[ $? != 0 ]]
    then
        echo "Could not find a site named ${1}. Sure you have created it?"
        exit 1  
    fi
fi

if [[ -z "${BUILDSTORAGE}" ]]
then
    echo "No build storage defined. Exiting...."
    exit 1
fi

if [[ -z "$1" ]]
then
    BUILD=`pwd | awk -F/ '{print $NF}'`
else
    BUILD=$1
fi;

if [[ ! -d ${BUILDSTORAGE}${BUILD} ]]
then
    echo "Creating build storage '${BUILDSTORAGE}${BUILD}'."
    mkdir -p ${BUILDSTORAGE}${BUILD}
    if [[ $? != 0 ]]
    then
        echo "Could not create build storage ${BUILDSTORAGE}${BUILD}"
        exit 1
    fi
fi;


TARGET="${BUILDSTORAGE}${BUILD}/${BUILD}-build-"`date +%d-%m-%Y`".tar.bz2"
if [[ -e ${TARGET} ]]
then
	TARGET=`echo ${TARGET} | awk -F. '{print $1}'`
	PREFIX=`expr 1 + \`ls ${TARGET}* | wc -l\``
	TARGET="${TARGET}-${PREFIX}.tar.bz2"
	echo "Allready did a build today, prefixing with ${PREFIX}" 
fi

tar cjf ${TARGET} settings/siteaccess settings/override extension var/${BUILD}/storage
if [[ 0 != $? ]]
then
    echo "Could not save  ${BUILD} to ${TARGET}"
    exit 1
fi

echo "Created build ${TARGET}"
exit 0
